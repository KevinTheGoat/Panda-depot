import { useEffect, useRef, useCallback } from 'react'
import gsap from 'gsap'

// Inline panda logo paths (visible ones only)
const PANDA_PATHS = {
  leftEye: 'm 170.33333,303.95599 c -1.1,-0.75271 -2.65547,-1.63589 -3.45661,-1.96262 -0.80114,-0.32672 -3.20114,-1.91472 -5.33334,-3.52889 -2.13219,-1.61416 -6.82159,-5.15401 -10.42088,-7.86633 -3.59929,-2.71231 -7.94929,-6.01453 -9.66667,-7.33826 -3.42909,-2.64309 -18.79681,-18.18243 -23.28556,-23.54559 -8.00789,-9.56785 -16.10407,-20.57503 -18.508112,-25.16275 -0.897805,-1.71331 -2.366938,-4.19756 -3.26474,-5.52054 -1.9181,-2.82648 -6.766745,-12.60572 -9.766304,-19.69768 -3.723819,-8.80435 -6.375175,-19.22663 -8.649356,-34 C 75.972117,162.27846 77.774526,142.81145 82.179074,130 c 2.912663,-8.47202 9.676086,-21.50053 13.438982,-25.88777 1.676736,-1.95494 3.048611,-3.78547 3.048611,-4.06784 0,-0.798467 12.014603,-12.853758 15.000003,-15.050796 1.46666,-1.079362 4.12411,-3.244478 5.90543,-4.811369 1.78133,-1.56689 3.49639,-2.848892 3.81127,-2.848892 0.31487,0 2.90742,-1.481257 5.76123,-3.291682 5.41085,-3.432592 22.997,-11.348058 28.18873,-12.687654 1.65,-0.425742 4.5,-1.319015 6.33334,-1.985052 1.83333,-0.666037 4.98333,-1.419323 7,-1.673968 2.01666,-0.254644 6.10309,-1.025401 9.08095,-1.712791 15.63374,-3.6088 51.97697,-3.613772 68.25238,-0.0093 3.11667,0.690233 7.5362,1.442989 9.82119,1.672792 2.28499,0.229802 5.79854,0.983444 7.80788,1.674759 2.00934,0.691315 5.0898,1.46023 6.84547,1.7087 4.79834,0.679083 17.36543,4.722836 30.9111,9.946363 2.4121,0.930163 4.63839,1.691206 4.94732,1.691206 0.30892,0 2.38538,0.864933 4.61436,1.922074 2.22897,1.05714 6.24833,2.911068 8.93189,4.119839 5.48195,2.469257 7.45412,4.479618 7.45412,7.59845 0,2.611284 -0.85262,3.419648 -10.19472,9.665459 -3.95709,2.645583 -7.70709,5.335142 -8.33333,5.976802 -0.62624,0.64166 -2.54112,2.1145 -4.2553,3.27299 -1.71418,1.15849 -3.51418,2.50233 -4,2.98632 -0.48582,0.48399 -2.2178,1.84553 -3.84883,3.02565 -6.96461,5.03918 -30.0937,27.23032 -39.44266,37.84315 -8.30914,9.43243 -17.39739,20.39613 -19.71919,23.78843 -0.80338,1.17379 -2.39607,3.33417 -3.5393,4.80084 -2.63053,3.37474 -4.96047,6.77147 -6.40208,9.33333 -0.61899,1.1 -2.44441,3.71867 -4.05648,5.81927 -1.61208,2.10059 -3.34114,4.80059 -3.84235,6 -0.50122,1.1994 -1.49254,2.93073 -2.20294,3.8474 -0.71041,0.91666 -3.15313,5.11666 -5.42827,9.33333 -2.27515,4.21667 -4.58753,8.41667 -5.13862,9.33333 -0.5511,0.91667 -1.46438,2.71667 -2.02953,4 -0.56514,1.28334 -1.58048,2.93334 -2.25632,3.66667 -0.67583,0.73333 -1.51655,2.6144 -1.86826,4.18016 -0.35172,1.56575 -1.18726,3.66575 -1.85677,4.66666 -1.37266,2.05212 -3.67772,7.21474 -5.87276,13.15318 -0.81319,2.2 -1.82661,4.6 -2.25204,5.33333 -0.42543,0.73334 -2.00909,5.23334 -3.51924,10 -1.51016,4.76667 -3.46467,10.51784 -4.34337,12.78037 -0.8787,2.26254 -1.59764,5.047 -1.59764,6.1877 0,1.1407 -0.57502,3.78953 -1.27784,5.8863 -0.70281,2.09676 -1.4755,5.0123 -1.71709,6.47897 -0.63898,3.87908 -1.68902,6.29567 -3.05267,7.02547 -1.93654,1.03641 -4.80602,0.73257 -6.9524,-0.73615 z',
  rightEye: 'm 799.70192,302.96024 c -0.61495,-0.93854 -1.37858,-3.26354 -1.69694,-5.16667 -0.31836,-1.90313 -1.01135,-4.6642 -1.53998,-6.13571 -0.52862,-1.47151 -1.17746,-4.02151 -1.44186,-5.66667 -0.56893,-3.53992 -8.78885,-28.33243 -10.04519,-30.29779 -0.47818,-0.74804 -1.22473,-2.70683 -1.65899,-4.35287 -0.43426,-1.64605 -1.50868,-4.34366 -2.3876,-5.9947 -0.87891,-1.65104 -1.59803,-3.33741 -1.59803,-3.74749 0,-0.41009 -0.73466,-1.8282 -1.63259,-3.15137 -0.89792,-1.32317 -1.8318,-3.46764 -2.07528,-4.7655 -0.24348,-1.29785 -0.96818,-3.03213 -1.61044,-3.85394 -0.64226,-0.82181 -1.76744,-2.6942 -2.5004,-4.16086 -3.24157,-6.48645 -10.9099,-20.09337 -13.78704,-24.46415 -1.1335,-1.72195 -2.96091,-4.52192 -4.06091,-6.22215 -1.1,-1.70024 -3.1293,-4.79137 -4.50956,-6.86919 -1.38026,-2.07782 -3.03026,-4.65241 -3.66667,-5.72131 -0.63641,-1.06891 -2.06008,-3.01891 -3.16372,-4.33334 -1.10364,-1.31442 -3.04339,-3.88986 -4.31056,-5.7232 -3.5,-5.06377 -15.01661,-19.00619 -20.34949,-24.63583 -1.1,-1.16121 -4.1,-4.43594 -6.66667,-7.27718 -8.27826,-9.16383 -30.32301,-28.99816 -38.84967,-34.95423 -1.73268,-1.21032 -4.65033,-3.39569 -6.48366,-4.85638 -1.83334,-1.460692 -5.43334,-4.037167 -8,-5.7255 -8.32002,-5.472843 -9,-6.09958 -9,-8.295298 0,-1.105446 0.29315,-2.557658 0.65144,-3.227138 0.81171,-1.516687 5.25134,-4.146849 11.3486,-6.723236 2.56664,-1.084529 6.84162,-2.901137 9.49996,-4.036907 5.93542,-2.5359 10.62189,-4.242458 17.23246,-6.275115 2.78618,-0.856714 6.1404,-2.00666 7.4538,-2.555436 1.31341,-0.548776 4.8838,-1.493191 7.93421,-2.098699 3.05041,-0.605509 7.04619,-1.641556 8.87953,-2.302328 1.83333,-0.660772 5.43333,-1.416265 8,-1.678873 2.56666,-0.262608 6.61666,-0.926321 9,-1.474919 7.42605,-1.709335 21.7707,-2.843356 36,-2.845994 15.465,-0.0029 24.01728,0.665534 33.66666,2.631209 3.66667,0.746936 8.31079,1.689151 10.32026,2.093811 16.93509,3.410322 40.53028,14.455529 54.67974,25.596287 8.47013,6.669056 20.05677,19.795436 24.10511,27.308426 4.00399,7.43067 7.18341,14.11109 7.61489,16 0.25127,1.1 1.00347,3.2287 1.67156,4.73045 1.16909,2.62792 2.31639,8.96171 4.01044,22.13992 1.4079,10.95222 -0.30053,26.48817 -4.70188,42.75731 -1.86819,6.90563 -4.98132,15.0844 -6.91015,18.15433 -0.53609,0.85323 -1.35362,2.75132 -1.81675,4.21799 -0.46313,1.46667 -1.29486,3.36272 -1.84829,4.21345 -0.55343,0.85072 -1.48295,2.41162 -2.06558,3.46866 -11.24196,20.3955 -31.2098,43.92867 -49.79921,58.69107 -10.61594,8.43042 -21.79463,16.61566 -22.72772,16.64164 -0.29283,0.008 -1.28242,0.60149 -2.19908,1.31851 -1.09823,0.85905 -2.72056,1.30874 -4.75666,1.31851 -2.58822,0.0124 -3.27156,-0.26228 -4.20809,-1.6916 z',
  leftBody: 'm 335.66667,532.2832 c -2.95514,-0.28197 -12.97275,-1.9545 -19.66667,-3.28353 -6.04523,-1.20023 -14.72516,-3.80519 -20.85069,-6.25757 -2.85121,-1.14149 -5.76565,-2.07543 -6.47654,-2.07543 -1.58872,0 -2.67277,1.89276 -2.67277,4.66666 0,2.60904 -0.93759,4.40796 -2.82343,5.41723 -1.03148,0.55203 -10.51894,0.86631 -32.34912,1.0716 -34.21789,0.32177 -32.77322,0.48546 -35.52345,-4.02505 -1.26142,-2.06879 -1.29926,-3.82822 -1.30732,-60.79711 -0.009,-61.18424 0.087,-63.79201 3.05098,-83.15023 1.13588,-7.41869 4.33166,-18.35478 6.28934,-21.52238 0.78365,-1.18329 1.32967,-2.50993 1.32967,-2.94809 0,-0.87416 3.22014,-8.1227 5.53444,-12.45804 6.90645,-12.93774 23.87233,-31.79306 35.69846,-39.67411 2.80524,-1.86944 5.70043,-3.9456 6.43376,-4.61369 2.21984,-2.02233 24.69125,-12.68207 29.50272,-13.99517 2.47351,-0.67504 6.21845,-1.82819 8.32209,-2.56254 4.99759,-1.74458 13.9258,-3.25893 24.73351,-4.19516 15.39818,-1.33388 33.33382,0.87711 48.77502,6.01268 27.15661,9.03198 46.63652,22.80768 65.66666,46.43781 6.7484,8.37963 15.15645,24.95052 18.02742,35.52907 0.6677,2.46025 1.67237,5.71674 2.23261,7.23665 0.56023,1.51991 1.31709,4.96991 1.68191,7.66667 0.36483,2.69676 1.15153,7.9032 1.74824,11.56986 1.78404,10.9627 0.2281,27.05179 -4.02951,41.66667 -1.2284,4.21667 -2.7092,9.37873 -3.29066,11.47126 -1.02206,3.67809 -2.20159,6.15039 -8.36296,17.52874 -4.78529,8.83712 -16.5433,24.34025 -20.93652,27.60514 -0.69454,0.51616 -2.24236,1.86616 -3.43959,3 -2.64961,2.50932 -7.69643,6.72654 -11.2976,9.44051 C 418.76024,509.23603 407.75248,516 407.09426,516 c -0.22416,0 -1.83707,0.87699 -3.58424,1.94887 -1.74718,1.07187 -4.82669,2.58552 -6.84335,3.36365 C 394.65,522.09065 392.1,523.137 391,523.63773 c -3.78786,1.72426 -18.67776,5.62262 -24.33333,6.37076 -3.11667,0.41229 -6.79623,1.04245 -8.1768,1.40036 -2.6823,0.69538 -18.39167,1.2972 -22.8232,0.87435 z',
  rightBody: 'm 630,531.79255 c -0.18333,-0.17962 -3.78333,-0.67294 -8,-1.09626 -10.00274,-1.00422 -14.77519,-1.81454 -19.66667,-3.33923 -2.2,-0.68575 -5.17139,-1.44392 -6.60309,-1.68482 -1.4317,-0.2409 -4.46075,-1.31571 -6.73123,-2.38846 -2.27047,-1.07274 -4.56336,-1.95045 -5.09531,-1.95045 -1.76568,0 -16.2119,-7.76335 -23.9037,-12.84578 -5.69581,-3.76356 -16.70027,-13.54566 -22.53277,-20.02988 -9.0517,-10.06311 -13.29496,-16.42504 -19.8699,-29.791 -3.62935,-7.37798 -4.95242,-11.04256 -7.34119,-20.33334 -3.55584,-13.82994 -4.4976,-22.50922 -3.9424,-36.33333 0.44806,-11.15634 0.55039,-11.85281 3.72185,-25.33333 2.44787,-10.40484 9.11787,-26.15844 14.81884,-35 6.89049,-10.68638 18.00023,-22.84211 28.14557,-30.79553 9.36929,-7.34503 23.40918,-15.71836 29.33333,-17.49428 1.46667,-0.43967 3.71667,-1.35378 5,-2.03136 1.28334,-0.67758 4.28334,-1.73243 6.66667,-2.34411 2.38333,-0.61168 6.08349,-1.69889 8.22257,-2.41602 2.13907,-0.71713 6.93907,-1.76459 10.66666,-2.32769 31.82846,-4.80812 59.06543,0.229 87.91421,16.25855 12.84768,7.13869 27.8238,20.47461 37.71651,33.58577 4.04703,5.36367 10.81336,16.10762 10.81588,17.17404 10e-4,0.58151 0.56389,1.97793 1.25006,3.10315 0.68616,1.12522 1.47503,2.77522 1.75304,3.66666 0.278,0.89145 1.21267,3.09616 2.07705,4.89936 6.14154,12.8121 9.12918,34.33689 7.68511,55.36822 -0.48269,7.02983 -0.78104,29.75896 -0.78348,59.68657 -0.003,37.63321 -0.19056,48.7023 -0.84695,50 -1.76128,3.48211 -2.73282,3.60249 -30.47066,3.77549 -24.45915,0.15254 -25.79705,0.0975 -28.43802,-1.17051 -3.46006,-1.66124 -5.2061,-4.9301 -4.68973,-8.7799 0.69553,-5.18562 -0.76768,-5.6554 -7.53892,-2.42045 -6.55513,3.1317 -12.81336,5.21843 -26.66666,8.89166 -6.43163,1.70536 -31.73086,4.41309 -32.66667,3.49626 z',
  leftWhite: 'm 354.42476,463.32638 c 9.62186,-1.97542 17.82654,-5.14237 23.85095,-9.20629 2.96503,-2.00013 5.51386,-3.97039 5.66407,-4.37835 0.15021,-0.40796 2.12772,-2.69174 4.39447,-5.07507 9.75419,-10.25586 13.16434,-18.34082 15.48205,-36.70567 0.73585,-5.83065 -4.2598,-23.73486 -8.66089,-31.04032 -2.3288,-3.8656 -11.73992,-13.44926 -16.15541,-16.4516 -2.2,-1.4959 -4.3,-3.09613 -4.66667,-3.55606 -0.60543,-0.75944 -8.9879,-3.62912 -19.33333,-6.61863 -8.2392,-2.38087 -24.50482,-0.99793 -31.63607,2.68979 -1.21083,0.62614 -3.68548,1.57913 -5.49922,2.11776 -7.56803,2.24746 -22.26215,16.137 -26.78281,25.3163 -1.42162,2.88664 -3.16461,6.37128 -3.87331,7.74366 -0.76485,1.48112 -1.5473,5.00345 -1.9252,8.66667 -0.35017,3.39429 -0.79433,6.67102 -0.98703,7.28164 -0.19271,0.61061 0.11752,4.90614 0.68939,9.5456 0.99845,8.10019 3.63319,16.66653 6.0522,19.67752 0.44186,0.55 1.36409,2.10244 2.04939,3.44987 2.7411,5.38953 12.77164,15.10957 20.72509,20.08356 3.76896,2.35705 11.81298,4.99732 20.64803,6.77723 8.47445,1.70727 10.23823,1.67921 19.9643,-0.31761 z',
  rightWhite: 'm 653.33333,464.67657 c 11.65798,-4.04848 19.16633,-8.57247 26.19521,-15.78331 4.77681,-4.90047 13.13813,-16.91125 13.13813,-18.87252 0,-0.65743 0.80767,-3.25605 1.79482,-5.7747 1.72729,-4.40708 1.79431,-5.05595 1.78124,-17.24604 -0.0113,-10.53264 -0.21276,-13.17209 -1.19586,-15.66667 -0.65026,-1.65 -1.57785,-4.43708 -2.06132,-6.19352 -0.48347,-1.75644 -2.778,-6.23091 -5.09896,-9.94326 -3.37889,-5.4045 -5.48216,-7.86605 -10.55326,-12.35089 -6.15551,-5.44389 -9.95475,-7.67759 -22.73814,-13.36848 -5.06548,-2.25504 -16.90277,-3.23288 -27.44778,-2.26737 -9.82729,0.8998 -11.25942,1.30308 -21.18322,5.96513 -5.4377,2.55455 -8.27129,4.42958 -12.92748,8.55436 C 587.39864,366.72389 580,375.36784 580,376.96031 c 0,0.4016 -0.7018,1.77482 -1.55955,3.0516 -2.37542,3.53587 -5.04673,12.71404 -5.85031,20.10073 -0.92726,8.52346 0.12331,20.65703 2.12028,24.48829 0.74274,1.42499 1.53255,3.74773 1.75512,5.16165 0.22258,1.41391 1.10888,3.41877 1.96957,4.45524 0.86069,1.03646 1.56489,2.30106 1.56489,2.8102 0,1.05033 8.81382,11.49351 12.54094,14.85932 4.28452,3.86917 11.24519,8.08809 17.9589,10.88501 9.71313,4.0465 12.80804,4.57087 25.50016,4.32055 10.43541,-0.20581 11.32507,-0.32984 17.33333,-2.41633 z',
}

export default function SplashScreen({ onComplete }) {
  const containerRef = useRef(null)
  const lettersRef = useRef([])
  const svgRef = useRef(null)
  const leftEyeRef = useRef(null)
  const rightEyeRef = useRef(null)
  const bodyRefs = useRef([])

  const text = 'panda depot inc'
  const pIndex = 0  // 'p' from "panda"
  const dIndex = 6  // 'd' from "depot"

  const onCompleteRef = useRef(onComplete)
  onCompleteRef.current = onComplete

  useEffect(() => {
    const letters = lettersRef.current.filter(Boolean)
    const pEl = letters[pIndex]
    const dEl = letters[dIndex]
    const svg = svgRef.current
    const container = containerRef.current
    const leftEye = leftEyeRef.current
    const rightEye = rightEyeRef.current
    const bodies = bodyRefs.current.filter(Boolean)

    if (!pEl || !dEl || !svg || !container) return

    const fadeLetters = letters.filter((_, i) => i !== pIndex && i !== dIndex)

    // Set initial states
    gsap.set(svg, { opacity: 0, scale: 0.6 })
    gsap.set([leftEye, rightEye], { opacity: 0 })
    gsap.set(bodies, { opacity: 0, scale: 0.8 })

    const tl = gsap.timeline({
      onComplete: () => onCompleteRef.current?.(),
    })

    // Phase 1: Letters stagger in
    tl.fromTo(
      letters,
      { opacity: 0, y: 30 },
      { opacity: 1, y: 0, stagger: 0.04, duration: 0.5, ease: 'power2.out' }
    )

    // Phase 2: Brief hold
    .to({}, { duration: 0.5 })

    // Phase 3: All letters except p and d sink away
    .to(fadeLetters, {
      opacity: 0,
      y: 50,
      stagger: { each: 0.015, from: 'edges' },
      duration: 0.4,
      ease: 'power3.in',
    })

    // Phase 4: p and d grow larger and move toward center
    .to(pEl, {
      fontSize: '6rem',
      fontWeight: 900,
      x: () => {
        const cr = container.getBoundingClientRect()
        const pr = pEl.getBoundingClientRect()
        return cr.width / 2 - pr.left - pr.width / 2 + 45
      },
      y: -20,
      duration: 0.6,
      ease: 'power3.inOut',
    })
    .to(dEl, {
      fontSize: '6rem',
      fontWeight: 900,
      scaleX: -1, // Flip the d horizontally
      x: () => {
        const cr = container.getBoundingClientRect()
        const dr = dEl.getBoundingClientRect()
        return cr.width / 2 - dr.left - dr.width / 2 - 45
      },
      y: -20,
      duration: 0.6,
      ease: 'power3.inOut',
    }, '<')

    // Phase 5: Trim tails with clip-path (keep only the round bowl)
    .to([pEl, dEl], {
      clipPath: 'inset(0% 0% 40% 0%)',
      duration: 0.4,
      ease: 'power2.inOut',
    })

    // Phase 6: Quick crossfade — letters out, SVG eyes in
    .to([pEl, dEl], {
      opacity: 0,
      scale: 1.2,
      duration: 0.3,
      ease: 'power2.in',
    })
    .to(svg, {
      opacity: 1,
      scale: 1,
      duration: 0.01,
    }, '<')
    .to([leftEye, rightEye], {
      opacity: 1,
      duration: 0.3,
      ease: 'power2.out',
    }, '<+=0.1')

    // Phase 7: Body parts grow in from eyes outward
    .to(bodies, {
      opacity: 1,
      scale: 1,
      stagger: 0.08,
      duration: 0.5,
      ease: 'back.out(1.4)',
    }, '-=0.1')

    // Phase 8: Hold the full logo
    .to({}, { duration: 0.7 })

    // Phase 9: Fade out splash
    .to(container, {
      opacity: 0,
      scale: 1.05,
      duration: 0.5,
      ease: 'power2.in',
    })

    return () => tl.kill()
  }, [])

  return (
    <div
      ref={containerRef}
      className="fixed inset-0 z-[100] flex items-center justify-center"
      style={{ background: '#FFF8F0' }}
    >
      {/* Text layer */}
      <div className="absolute inset-0 flex items-center justify-center">
        <div className="flex items-baseline">
          {text.split('').map((char, i) => (
            <span
              key={i}
              ref={(el) => (lettersRef.current[i] = el)}
              className="inline-block select-none"
              style={{
                color: '#1A1008',
                fontSize: 'clamp(2rem, 5vw, 3rem)',
                fontFamily: '"Noto Sans SC", system-ui, sans-serif',
                fontWeight: 700,
                lineHeight: 1.3,
                marginRight: char === ' ' ? '0.4em' : '0.01em',
                clipPath: 'inset(0% 0% 0% 0%)',
                willChange: 'transform, opacity, clip-path',
              }}
            >
              {char === ' ' ? '' : char}
            </span>
          ))}
        </div>
      </div>

      {/* Inline SVG panda logo layer */}
      <svg
        ref={svgRef}
        viewBox="0 0 1000 552"
        className="w-[280px] md:w-[360px] h-auto"
        style={{ opacity: 0 }}
      >
        {/* Eyes — animate in first */}
        <path ref={leftEyeRef} d={PANDA_PATHS.leftEye} fill="#000" />
        <path ref={rightEyeRef} d={PANDA_PATHS.rightEye} fill="#000" />
        {/* Body parts — animate in after */}
        <path ref={(el) => (bodyRefs.current[0] = el)} d={PANDA_PATHS.leftBody} fill="#000" />
        <path ref={(el) => (bodyRefs.current[1] = el)} d={PANDA_PATHS.rightBody} fill="#000" />
        <path ref={(el) => (bodyRefs.current[2] = el)} d={PANDA_PATHS.leftWhite} fill="#fff" />
        <path ref={(el) => (bodyRefs.current[3] = el)} d={PANDA_PATHS.rightWhite} fill="#fff" />
      </svg>
    </div>
  )
}
